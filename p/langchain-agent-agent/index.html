<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='langchain agentç¯‡agent'>
<title>langchain</title>

<link rel='canonical' href='https://jhrsya.github.io/p/langchain-agent-agent/'>

<link rel="stylesheet" href="/scss/style.min.8191399262444ab68b72a18c97392f5349be20a1615d77445be51e974c144cff.css"><meta property='og:title' content='langchain'>
<meta property='og:description' content='langchain agentç¯‡agent'>
<meta property='og:url' content='https://jhrsya.github.io/p/langchain-agent-agent/'>
<meta property='og:site_name' content='steve lannister'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='AI' /><meta property='article:tag' content='langchain' /><meta property='article:published_time' content='2023-05-12T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2023-05-12T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="langchain">
<meta name="twitter:description" content="langchain agentç¯‡agent">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu75249b9e118adc4b16bd3e4fa099a7b0_35085_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">steve lannister</a></h1>
            <h2 class="site-description">to be or not to be, it is a problem</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/jhrsya'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.zhihu.com'
                        target="_blank"
                        title="ZhiHu"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg t="1683874979068" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2376" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M512 73.28A438.72 438.72 0 1 0 950.72 512 438.72 438.72 0 0 0 512 73.28z m-98.56 458.88l-16.8 66.88 23.68-20.8s53.92 61.28 64 76.48 1.44 68.96 1.44 68.96l-92.48-113.12s-29.12 101.12-68.48 124.16a97.6 97.6 0 0 1-80 6.56 342.08 342.08 0 0 0 85.44-89.76 382.88 382.88 0 0 0 39.52-119.36h-115.04s8.8-40.48 24.16-41.6 90.88 0 90.88 0l-1.76-124.8-43.2 2.24a96 96 0 0 1-32 48c-24.16 17.44-38.4 10.88-38.4 10.88s42.72-118.24 55.84-141.28 50.4-25.12 50.4-25.12l-23.04 66.72h147.84c17.6 0 18.56 40.64 18.56 40.64h-90.56v122.56s61.28-2.24 81.12 0 19.68 41.6 19.68 41.6z m329.44 160h-91.52l-65.12 46.24-13.6-46.24h-36.96v-368h208z" fill="#49C0FB" p-id="2377"></path><path d="M602.88 691.68l54.88-41.44h43.04V364.64h-121.12v285.6h11.2l12 41.44z" fill="#49C0FB" p-id="2378"></path></svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        

        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#agents-types">Agents Types</a></li>
    <li><a href="#custom-agent">Custom Agent</a></li>
    <li><a href="#custom-llm-agent">Custom LLM Agent</a>
      <ol>
        <li><a href="#set-up-tool">Set up tool</a></li>
        <li><a href="#prompt-template">Prompt Template</a></li>
        <li><a href="#output-parser">Output Parser</a></li>
        <li><a href="#set-up-llm">Set up LLM</a></li>
        <li><a href="#define-the-stop-sequence">Define the stop sequence</a></li>
        <li><a href="#set-up-the-agent">Set up the Agent</a></li>
        <li><a href="#use-the-agent">Use the Agent</a></li>
        <li><a href="#adding-memory">Adding Memory</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/ai%E6%A1%86%E6%9E%B6/" >
                AIæ¡†æ¶
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/langchain-agent-agent/">langchain</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            langchain agentç¯‡agent
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 12, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 7 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="langchain-agentsç¯‡agents">langchain agentsç¯‡agents</h1>
<h2 id="agents-types">Agents Types</h2>
<p>Agentsä½¿ç”¨LLMå†³å®šåšä»€ä¹ˆactionä»¥åŠä»¥ä»€ä¹ˆé¡ºåºåšactionã€‚ä¸€ä¸ªactionè¦ä¹ˆæ˜¯ä½¿ç”¨ä¸€ä¸ªå·¥å…·è§‚å¯Ÿå®ƒçš„ç»“æœï¼Œè¦ä¹ˆæ˜¯ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªresponseã€‚
ä¸‹é¢æ˜¯åœ¨Langchainä¸­å¯ä»¥ä½¿ç”¨çš„Agentsç±»å‹ï¼š</p>
<ul>
<li>zero-shot-react-description
<ul>
<li>è¿™ä¸ªagentä½¿ç”¨ReAct æ¡†æ¶å†³å®šä½¿ç”¨å“ªä¸€ç§toolï¼Œä»…ä»…åŸºäºtool&rsquo;s descriptionã€‚è¿™ä¸ªagentéœ€è¦ç»™æ¯ä¸€ä¸ªtoolå†™ä¸€ä¸ªdescription</li>
</ul>
</li>
<li>react-docstore
<ul>
<li>è¿™ä¸ªagentä½¿ç”¨ReActæ¡†æ¶å»å’Œdocstore(æ–‡æ¡£åº“)äº¤äº’ã€‚å¿…é¡»æä¾›ä¸¤ä¸ª<code>Tool</code>: <code>Search</code> å’Œ <code>Lookup</code> Toolã€‚<code>Search</code> tool æ˜¯ä»æ–‡æ¡£ä¸­æœç´¢ï¼Œ<code>Lookup</code> toolæ˜¯ä»æœ€è¿‘æ‰¾åˆ°çš„æ–‡ä»¶ä¸­æŸ¥æ‰¾ä¸€ä¸ªæœ¯è¯­ã€‚<a class="link" href="https://arxiv.org/pdf/2210.03629.pdf"  target="_blank" rel="noopener"
    >paperé“¾æ¥</a></li>
</ul>
</li>
<li>self-ask-with-search
<ul>
<li>è¿™ä¸ªagentåªæ˜¯ç”¨ä¸€ä¸ªtool: <code>Intermediate Answer</code>ï¼Œè¿™ä¸ªtoolå¯ä»¥ç»™é—®é¢˜æŸ¥æ‰¾æ­£ç¡®çš„ç­”æ¡ˆã€‚<a class="link" href="https://ofir.io/self-ask.pdf"  target="_blank" rel="noopener"
    >paperé“¾æ¥</a></li>
</ul>
</li>
<li>conversational-react-description
<ul>
<li>è¿™ä¸ªagentä¸“é—¨ç”¨äºå¯¹è¯ï¼Œpromptè¢«è®¾è®¡æˆè®©agentæ›´å®¹æ˜“å¯¹è¯ã€‚å®ƒä½¿ç”¨ReActæ¡†æ¶å»å†³å®šä½¿ç”¨å“ªä¸€ä¸ªtoolï¼Œä½¿ç”¨memoryå»è®°ä½ä¹‹å‰çš„å¯¹è¯äº¤äº’ã€‚</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;api_key.json&#34;</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENAI_API_KEY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span><span class="p">[</span><span class="s2">&#34;OPANAI_API_KEY&#34;</span><span class="p">]</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;SERPAPI_API_KEY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">api_key</span><span class="p">[</span><span class="s2">&#34;SERPAPI_API_KEY&#34;</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="custom-agent">Custom Agent</h2>
<p>è‡ªå®šä¹‰Agent</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">langchain.agents</span> <span class="kn">import</span> <span class="n">Tool</span><span class="p">,</span> <span class="n">AgentExecutor</span><span class="p">,</span> <span class="n">BaseSingleActionAgent</span>
<span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">SerpAPIWrapper</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">SerpAPIWrapper</span><span class="p">()</span>
<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Tool</span><span class="p">(</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;Search&#34;</span><span class="p">,</span>
        <span class="n">func</span><span class="o">=</span><span class="n">search</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;useful for when you need to answer questions about current events&#34;</span><span class="p">,</span>
        <span class="n">return_direct</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">langchain.schema</span> <span class="kn">import</span> <span class="n">AgentAction</span><span class="p">,</span> <span class="n">AgentFinish</span>

<span class="k">class</span> <span class="nc">FakeAgent</span><span class="p">(</span><span class="n">BaseSingleActionAgent</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;Fake Custom Agent.&#34;&#34;&#34;</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">input_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&#34;input&#34;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">plan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">intermediate_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">AgentAction</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentAction</span><span class="p">,</span> <span class="n">AgentFinish</span><span class="p">]:</span>
        <span class="s2">&#34;&#34;&#34;Given input, decided what to do.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            intermediate_steps: Steps the LLM has taken to date,
</span><span class="s2">                along with observations
</span><span class="s2">            **kwargs: User inputs.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            Action specifying what tool to use.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="k">return</span> <span class="n">AgentAction</span><span class="p">(</span><span class="n">tool</span><span class="o">=</span><span class="s2">&#34;Search&#34;</span><span class="p">,</span> <span class="n">tool_input</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;input&#34;</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">aplan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">intermediate_steps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">AgentAction</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentAction</span><span class="p">,</span> <span class="n">AgentFinish</span><span class="p">]:</span>
        <span class="s2">&#34;&#34;&#34;Given input, decided what to do.
</span><span class="s2">
</span><span class="s2">        Args:
</span><span class="s2">            intermediate_steps: Steps the LLM has taken to date,
</span><span class="s2">                along with observations
</span><span class="s2">            **kwargs: User inputs.
</span><span class="s2">
</span><span class="s2">        Returns:
</span><span class="s2">            Action specifying what tool to use.
</span><span class="s2">        &#34;&#34;&#34;</span>
        <span class="k">return</span> <span class="n">AgentAction</span><span class="p">(</span><span class="n">tool</span><span class="o">=</span><span class="s2">&#34;Search&#34;</span><span class="p">,</span> <span class="n">tool_input</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;input&#34;</span><span class="p">],</span> <span class="n">log</span><span class="o">=</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
    
<span class="n">agent</span> <span class="o">=</span> <span class="n">FakeAgent</span><span class="p">()</span>
<span class="n">agent_executor</span> <span class="o">=</span> <span class="n">AgentExecutor</span><span class="o">.</span><span class="n">from_agent_and_tools</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">agent_executor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;How many people live in china as of 2023?&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[1m&gt; Entering new AgentExecutor chain...[0m
[32;1m[1;3m[0m[36;1m[1;3m1,455,144,001[0m

[1m&gt; Finished chain.[0m





'1,455,144,001'
</code></pre>
<h2 id="custom-llm-agent">Custom LLM Agent</h2>
<p>è‡ªå®šä¹‰LLM agentï¼Œä¸€ä¸ªLLMç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>PromptTemplate: ç”¨äºæŒ‡å¯¼è¯­è¨€æ¨¡å‹åšä»€ä¹ˆ</li>
<li>LLM</li>
<li><code>stop</code> sequence: ä¸€å®šè¿™ä¸ª<code>stop</code> sequenceå‡ºç°ï¼Œè¯­è¨€æ¨¡å‹åœæ­¢ç”Ÿæˆ</li>
<li>OutputParser: è¿™ä¸ªå†³å®šäº†å¦‚ä½•è§£æLLMOutputä¸ºä¸€ä¸ªAgentActionæˆ–è€…AgentFinishå¯¹è±¡</li>
</ul>
<p>LLMAgentè¢«ç”¨äºAgentExecutor. è¿™ä¸ªAgentExecutorå¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå¾ªç¯ï¼š</p>
<ul>
<li>è§£æç”¨æˆ·çš„è¾“å…¥å’Œä¹‹å‰çš„æ­¥éª¤åç»™Agent(LLMAgent)</li>
<li>å¦‚æœAgentè¿”å›<code>AgentFinish</code>ï¼Œç›´æ¥è¿”å›ç»™ç”¨æˆ·</li>
<li>å¦‚æœAgentè¿”å›<code>AgentAction</code>ï¼Œä½¿ç”¨è¿™ä¸ªå»è°ƒç”¨ä¸€ä¸ªtoolï¼Œè·å¾—ä¸€ä¸ª<code>Observation</code>å¯¹è±¡</li>
<li>é‡å¤ï¼ŒæŠŠ<code>AgentAction</code>å’Œ<code>Observation</code>ä¼ ç»™Agentç›´åˆ°<code>AgentFinish</code>å‡ºç°ä¸ºæ­¢ã€‚</li>
</ul>
<p><code>AgentAction</code>æ˜¯ä¸€ä¸ªç”±<code>action</code>å’Œ<code>action_input</code>ç»„æˆçš„responseã€‚<code>action</code>æŒ‡å®šä½¿ç”¨å“ªä¸€ä¸ªtoolï¼Œ<code>action_input</code>æŒ‡å®šè¿™ä¸ªtoolçš„è¾“å…¥ã€‚<code>log</code>å¯ä»¥æä¾›æ›´å¤šå†…å®¹(æ¯”å¦‚logging, tracing, etc)</p>
<p><code>AgentFinish</code>æ˜¯åŒ…å«äº†æœ€ç»ˆå‘é€ç»™ç”¨æˆ·çš„æ¶ˆæ¯ï¼Œç”¨äºç»ˆæ­¢agentçš„è¿è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Set up environment</span>
<span class="kn">from</span> <span class="nn">langchain.agents</span> <span class="kn">import</span> <span class="n">Tool</span><span class="p">,</span> <span class="n">AgentExecutor</span><span class="p">,</span> <span class="n">LLMSingleActionAgent</span><span class="p">,</span> <span class="n">AgentOutputParser</span>
<span class="kn">from</span> <span class="nn">langchain.prompts</span> <span class="kn">import</span> <span class="n">StringPromptTemplate</span>
<span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">OpenAI</span><span class="p">,</span> <span class="n">SerpAPIWrapper</span><span class="p">,</span> <span class="n">LLMChain</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">langchain.schema</span> <span class="kn">import</span> <span class="n">AgentAction</span><span class="p">,</span> <span class="n">AgentFinish</span>
<span class="kn">import</span> <span class="nn">re</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="set-up-tool">Set up tool</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Define which tools the agent can use to answer user queries</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">SerpAPIWrapper</span><span class="p">()</span>
<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Tool</span><span class="p">(</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;Search&#34;</span><span class="p">,</span>
        <span class="n">func</span><span class="o">=</span><span class="n">search</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;useful for when you need to answer questions about current events&#34;</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="prompt-template">Prompt Template</h3>
<p>å®ƒæŒ‡å®šäº†agentåšä»€ä¹ˆã€‚é€šå¸¸è¿™ä¸ªæ¨¡æ¿éœ€è¦åŒ…å«ï¼š</p>
<ul>
<li><code>tool</code>: agentéœ€è¦ä½¿ç”¨çš„toolå’Œä»€ä¹ˆæ—¶å€™è°ƒç”¨å®ƒä»¬</li>
<li><code>intermediate_steps</code>: æ˜¯ä¸€ä¸ª(<code>AgentAction</code>, <code>Observation</code>)å…ƒç»„ã€‚å®ƒä»¬é€šå¸¸ä¸ä¼šç›´æ¥ä¼ ç»™æ¨¡å‹ï¼Œprompt templateä¼šä»¥ä¸€ç§ç‰¹åˆ«çš„æ–¹å¼æ ¼å¼åŒ–å®ƒä»¬</li>
<li><code>input</code>: é€šç”¨çš„ç”¨æˆ·è¾“å…¥</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Set up the base template</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;Answer the following questions as best you can, but speaking as a pirate might speak. You have access to the following tools:
</span><span class="s2">
</span><span class="s2"></span><span class="si">{tools}</span><span class="s2">
</span><span class="s2">
</span><span class="s2">Use the following format:
</span><span class="s2">
</span><span class="s2">Question: the input question you must answer
</span><span class="s2">Thought: you should always think about what to do
</span><span class="s2">Action: the action to take, should be one of [</span><span class="si">{tool_names}</span><span class="s2">]
</span><span class="s2">Action Input: the input to the action
</span><span class="s2">Observation: the result of the action
</span><span class="s2">... (this Thought/Action/Action Input/Observation can repeat N times)
</span><span class="s2">Thought: I now know the final answer
</span><span class="s2">Final Answer: the final answer to the original input question
</span><span class="s2">
</span><span class="s2">Begin! Remember to speak as a pirate when giving your final answer. Use lots of &#34;Arg&#34;s
</span><span class="s2">
</span><span class="s2">Question: </span><span class="si">{input}</span><span class="s2">
</span><span class="s2"></span><span class="si">{agent_scratchpad}</span><span class="s2">&#34;&#34;&#34;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Set up a prompt template</span>
<span class="k">class</span> <span class="nc">CustomPromptTemplate</span><span class="p">(</span><span class="n">StringPromptTemplate</span><span class="p">):</span>
    <span class="c1"># The template to use</span>
    <span class="n">template</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1"># The list of tools available</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tool</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Get the intermediate steps (AgentAction, Observation tuples)</span>
        <span class="c1"># Format them in a particular way</span>
        <span class="n">intermediate_steps</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&#34;intermediate_steps&#34;</span><span class="p">)</span>
        <span class="n">thoughts</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
        <span class="k">for</span> <span class="n">action</span><span class="p">,</span> <span class="n">observation</span> <span class="ow">in</span> <span class="n">intermediate_steps</span><span class="p">:</span>
            <span class="n">thoughts</span> <span class="o">+=</span> <span class="n">action</span><span class="o">.</span><span class="n">log</span>
            <span class="n">thoughts</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Observation: </span><span class="si">{</span><span class="n">observation</span><span class="si">}</span><span class="se">\n</span><span class="s2">Thought: &#34;</span>
        <span class="c1"># Set the agent_scratchpad variable to that value</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;agent_scratchpad&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thoughts</span>
        <span class="c1"># Create a tools variable from the list of tools provided</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;tools&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">tool</span><span class="o">.</span><span class="n">description</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">])</span>
        <span class="c1"># Create a list of tool names for the tools provided</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&#34;tool_names&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;, &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tools</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
<span class="n">prompt</span> <span class="o">=</span> <span class="n">CustomPromptTemplate</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
    <span class="c1"># This omits the `agent_scratchpad`, `tools`, and `tool_names` variables because those are generated dynamically</span>
    <span class="c1"># This includes the `intermediate_steps` variable because that is needed</span>
    <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="s2">&#34;intermediate_steps&#34;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="output-parser">Output Parser</h3>
<p>ç”¨äºæŠŠLLM outputè§£ææˆ<code>AgentAction</code>å’Œ<code>AgentFinish</code>ã€‚è¿™ä¸ªé€šå¸¸å–å†³äºpromptçš„ä½¿ç”¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">CustomOutputParser</span><span class="p">(</span><span class="n">AgentOutputParser</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">AgentAction</span><span class="p">,</span> <span class="n">AgentFinish</span><span class="p">]:</span>
        <span class="c1"># Check if agent should finish</span>
        <span class="k">if</span> <span class="s2">&#34;Final Answer:&#34;</span> <span class="ow">in</span> <span class="n">llm_output</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AgentFinish</span><span class="p">(</span>
                <span class="c1"># Return values is generally always a dictionary with a single `output` key</span>
                <span class="c1"># It is not recommended to try anything else at the moment :)</span>
                <span class="n">return_values</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="n">llm_output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;Final Answer:&#34;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()},</span>
                <span class="n">log</span><span class="o">=</span><span class="n">llm_output</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Parse out the action and action input</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&#34;Action\s*\d*\s*:(.*?)\nAction\s*\d*\s*Input\s*\d*\s*:[\s]*(.*)&#34;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">llm_output</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Could not parse LLM output: `</span><span class="si">{</span><span class="n">llm_output</span><span class="si">}</span><span class="s2">`&#34;</span><span class="p">)</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">action_input</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Return the action and action input</span>
        <span class="k">return</span> <span class="n">AgentAction</span><span class="p">(</span><span class="n">tool</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">tool_input</span><span class="o">=</span><span class="n">action_input</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="p">),</span> <span class="n">log</span><span class="o">=</span><span class="n">llm_output</span><span class="p">)</span>
<span class="n">output_parser</span> <span class="o">=</span> <span class="n">CustomOutputParser</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="set-up-llm">Set up LLM</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">llm</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="define-the-stop-sequence">Define the stop sequence</h3>
<p>å‘Šè¯‰LLMä»€ä¹ˆæ—¶å€™åœæ­¢ç”Ÿæˆã€‚è¿™ä¸ªæ ‡å¿—å¾ˆå¤§çš„å–å†³äºpromptå’Œmodelã€‚</p>
<h3 id="set-up-the-agent">Set up the Agent</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># LLM chain consisting of the LLM and a prompt</span>
<span class="n">llm_chain</span> <span class="o">=</span> <span class="n">LLMChain</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
<span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">LLMSingleActionAgent</span><span class="p">(</span>
    <span class="n">llm_chain</span><span class="o">=</span><span class="n">llm_chain</span><span class="p">,</span> 
    <span class="n">output_parser</span><span class="o">=</span><span class="n">output_parser</span><span class="p">,</span>
    <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Observation:&#34;</span><span class="p">],</span> 
    <span class="n">allowed_tools</span><span class="o">=</span><span class="n">tool_names</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="use-the-agent">Use the Agent</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">agent_executor</span> <span class="o">=</span> <span class="n">AgentExecutor</span><span class="o">.</span><span class="n">from_agent_and_tools</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">agent_executor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;How many people live in china as of 2023?&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[1m&gt; Entering new AgentExecutor chain...[0m
[32;1m[1;3mThought: I need to find out the population of China in 2023
Action: Search
Action Input: Population of China in 2023[0m

Observation:[36;1m[1;3mThe current population of China is 1,455,144,001 as of Thursday, May 11, 2023, based on Worldometer elaboration of the latest United Nations data.[0m
[32;1m[1;3m I now know the final answer
Final Answer: Arg, there be 1,455,144,001 people livin' in China as of 2023![0m

[1m&gt; Finished chain.[0m





&quot;Arg, there be 1,455,144,001 people livin' in China as of 2023!&quot;
</code></pre>
<h3 id="adding-memory">Adding Memory</h3>
<p>ç»™agentæ·»åŠ è®°å¿†ï¼Œéœ€è¦åšä¸¤æ­¥ï¼š</p>
<ul>
<li>ç»™è‡ªå®šä¹‰çš„promotæ·»åŠ chat_history</li>
<li>ç»™agent executoræ·»åŠ ä¸€ä¸ªmemoryå¯¹è±¡</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Set up the base template</span>
<span class="n">template_with_history</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;Answer the following questions as best you can, but speaking as a pirate might speak. You have access to the following tools:
</span><span class="s2">
</span><span class="s2"></span><span class="si">{tools}</span><span class="s2">
</span><span class="s2">
</span><span class="s2">Use the following format:
</span><span class="s2">
</span><span class="s2">Question: the input question you must answer
</span><span class="s2">Thought: you should always think about what to do
</span><span class="s2">Action: the action to take, should be one of [</span><span class="si">{tool_names}</span><span class="s2">]
</span><span class="s2">Action Input: the input to the action
</span><span class="s2">Observation: the result of the action
</span><span class="s2">... (this Thought/Action/Action Input/Observation can repeat N times)
</span><span class="s2">Thought: I now know the final answer
</span><span class="s2">Final Answer: the final answer to the original input question
</span><span class="s2">
</span><span class="s2">Begin! Remember to speak as a pirate when giving your final answer. Use lots of &#34;Arg&#34;s
</span><span class="s2">
</span><span class="s2">Previous conversation history:
</span><span class="s2"></span><span class="si">{history}</span><span class="s2">
</span><span class="s2">
</span><span class="s2">New question: </span><span class="si">{input}</span><span class="s2">
</span><span class="s2"></span><span class="si">{agent_scratchpad}</span><span class="s2">&#34;&#34;&#34;</span>


<span class="n">prompt_with_history</span> <span class="o">=</span> <span class="n">CustomPromptTemplate</span><span class="p">(</span>
    <span class="n">template</span><span class="o">=</span><span class="n">template_with_history</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
    <span class="c1"># This omits the `agent_scratchpad`, `tools`, and `tool_names` variables because those are generated dynamically</span>
    <span class="c1"># This includes the `intermediate_steps` variable because that is needed</span>
    <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;input&#34;</span><span class="p">,</span> <span class="s2">&#34;intermediate_steps&#34;</span><span class="p">,</span> <span class="s2">&#34;history&#34;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">llm_chain</span> <span class="o">=</span> <span class="n">LLMChain</span><span class="p">(</span><span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="n">prompt_with_history</span><span class="p">)</span>

<span class="n">tool_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">]</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">LLMSingleActionAgent</span><span class="p">(</span>
    <span class="n">llm_chain</span><span class="o">=</span><span class="n">llm_chain</span><span class="p">,</span> 
    <span class="n">output_parser</span><span class="o">=</span><span class="n">output_parser</span><span class="p">,</span>
    <span class="n">stop</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Observation:&#34;</span><span class="p">],</span> 
    <span class="n">allowed_tools</span><span class="o">=</span><span class="n">tool_names</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">langchain.memory</span> <span class="kn">import</span> <span class="n">ConversationBufferWindowMemory</span>

<span class="n">memory</span><span class="o">=</span><span class="n">ConversationBufferWindowMemory</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">agent_executor</span> <span class="o">=</span> <span class="n">AgentExecutor</span><span class="o">.</span><span class="n">from_agent_and_tools</span><span class="p">(</span><span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>

<span class="n">agent_executor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;How many people live in china as of 2023?&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[1m&gt; Entering new AgentExecutor chain...[0m
[32;1m[1;3mThought: I need to find out the population of China in 2023
Action: Search
Action Input: Population of China in 2023[0m

Observation:[36;1m[1;3mThe current population of China is 1,455,144,001 as of Thursday, May 11, 2023, based on Worldometer elaboration of the latest United Nations data.[0m
[32;1m[1;3m I now know the final answer
Final Answer: Arrr, there be 1,455,144,001 people livin' in China as of 2023![0m

[1m&gt; Finished chain.[0m





&quot;Arrr, there be 1,455,144,001 people livin' in China as of 2023!&quot;
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">agent_executor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&#34;how about in india?&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>[1m&gt; Entering new AgentExecutor chain...[0m
[32;1m[1;3mThought: I need to find out how many people live in India.
Action: Search
Action Input: How many people live in India as of 2023[0m

Observation:[36;1m[1;3m24 April 2023 - China will soon cede its long-held status as the world's most populous country. By the end of this month, India's population is expected to reach 1,425,775,850 people, matching and then surpassing the population of mainland China.[0m
[32;1m[1;3m I now know the final answer.
Final Answer: Arg, there be 1,425,775,850 people livin' in India as of 2023![0m

[1m&gt; Finished chain.[0m





&quot;Arg, there be 1,425,775,850 people livin' in India as of 2023!&quot;
</code></pre>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ai/">AI</a>
        
            <a href="/tags/langchain/">langchain</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/langchain-agent-tools/">
        
        

        <div class="article-details">
            <h2 class="article-title">langchain</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/langchain/">
        
        

        <div class="article-details">
            <h2 class="article-title">langchain</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 steve lannister
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
